{% if overall_success %}
## Plans :thumbsup:
  {%- if account_status == 'trial_ending' %}
> [!WARNING]
> Your Terrateam trial ends in **{{ trial_end_days }} days**.  To avoid an interruption in service, please reach out to support@terrateam.io or contact us on [our Slack](https://terrateam.io/slack).

  {%- endif %}
  {%- if work_manifest_url is defined %}

Outputs can be viewed in the Terrateam Console [here]({{ work_manifest_url }}).

  {%- endif %}
  {%- if compact_view %}
The plan output exceeds the size limit for pull request comments. You can view the full plan by clicking the GitHub status check link or directly in the action log.

  {%- endif %}
  {%- if denied_dirspaces %}
<details open>
  <summary><h2>Access Control :no_entry:</h2></summary>

Not all [dirspaces](https://docs.terrateam.io/getting-started/concepts/#dirspace) were run because the user did not have access.  The following dirspaces were not run:

| Dir | Workspace | Policy |
| --- | --------- | ------ |
      {%- for dd in denied_dirspaces %}
| {{ dd.dir }} | {{ dd.workspace }} | {% if dd.policy %}{% for p in dd.policy %}`{{ p.item }}`{% endfor %}{% else %}**No matching policy**{% endif %}
      {%- endfor %}
</details>
  {%- endif -%}
  {%- if is_layered_run %}

> [!NOTE]
> This is a **layered run** with {{ num_more_layers }} {% if num_layers == 1 %}layer{% else %}layers{% endif %} remaining to apply.  Layered runs require multiple rounds of planning and applying.

  {%- endif %}
  {%- if gates %}

> [!IMPORTANT]
> Gates added to the change.

{%- set token_gates = gates | rejectattr("token", "none") %}
{%- set approval_gates = gates | selectattr("token", "none") %}

{%- if token_gates %}

### Token Gates
| Token | Directory | Workspace | Required Approvers           | Any Approvers | Any Remaining Count |
|------------|-----------|-----------|------------------------------|----------------|--------------------|
    {%- for g in token_gates %}
| `{{ g.token }}` | {% if g.dir %}`{{ g.dir }}`{% endif %} | {% if g.workspace %}`{{ g.workspace }}`{% endif %} | {% for p in g.all_of %}`{{ p.q }}` {% endfor %} | {% for p in g.any_of %}`{{ p.q }}` {% endfor %} | {{ g.any_of_count }} |
    {%- endfor %}

These gates are fulfilled by commenting `terrateam gate approve <token>`.
{%- endif %}
{%- if approval_gates %}

### Approval Gates
| Name | Directory | Workspace | Required Approvers           | Any Approvers | Any Remaining Count |
|------|-----------|-----------|------------------------------|----------------|--------------------|
    {%- for g in approval_gates %}
| {{ g.name | default('', true) }} | {% if g.dir %}`{{ g.dir }}`{% endif %} | {% if g.workspace %}`{{ g.workspace }}`{% endif %} | {% for p in g.all_of %}`{{ p.q }}` {% endfor %} | {% for p in g.any_of %}`{{ p.q }}` {% endfor %} | {{ g.any_of_count }} |
    {%- endfor %}

These gates are fulfilled by approving the pull request.
{%- endif %}

<details>
  <summary>Expand for details on gates</summary>

### What to do?

To continue, users matching the `Required Approvers` and `Any Approvers` must approve a token until all approvals are satisfied.

To approve a gate with a token, comment the following:

```
terrateam gate approve <token>
```

Where `<token>` is the token to be approved.

To approve a gate without a token, approve the pull request.

#### How Gatekeeper requirements work

Gatekeeper uses `all_of`, `any_of`, and `any_of_count` to define approval rules:

- `all_of` - Lists users or groups that must approve unconditionally.
- `any_of` - Lists users or groups that may approve.
- `any_of_count` - Sets how many approvals are required from the `any_of` list.

A gate is satisfied only when all conditions are met. See [documentation](https://docs.terrateam.io/advanced-workflows/gatekeeper-requirements) for details.
</details>

  {%- endif %}

## Terrateam Plan Output{% if environment is defined %}: {{ environment }}{% endif %} :thumbsup:
<details>
  <summary>Expand for plan output details</summary>

{%- else %}
## Plans :heavy_multiplication_x:
  {%- if work_manifest_url is defined %}
 
Outputs can be viewed in the Terrateam Console [here]({{ work_manifest_url }}).

  {%- endif %}
  {%- if compact_view %}
The plan output exceeds the size limit for pull request comments. You can view the full plan by clicking the GitHub status check link or directly in the action log.

  {%- endif %}

Running plans **FAILED**.  See **Terrateam Plan Output**.

After resolving the issue, run `terrateam plan` to execute the plan operation again.

## Terrateam Plan Output{% if environment is defined %}: {{ environment }}{% endif %} :heavy_multiplication_x:
<details>
  <summary>Expand for plan output details</summary>

{%- endif %}
{%- if pre_hooks %}
<details>
    <summary><h3>Pre Hooks</h3></summary>

    {%- for h in pre_hooks %}

**Step**: {{ h.name }}
**Success**: {% if h.success %}:thumbsup:{% else %}:heavy_multiplication_x:{% endif %}
      {% if h.cmd is defined %}
**Command** : `{{ h.cmd }}`
      {% endif %}
      {% if h.details is defined %}
**Details**: {{ h.details }}
      {% endif %}
      {% if not compact_view %}
```
{{ h.text }}
```
    {%- else %}

No output shown due to comment size.

    {%- endif %}
    {% endfor %}
</details>

{%- endif %}
{%- if post_hooks %}
<details>
    <summary><h3>Post Hooks</h3></summary>

    {%- for h in post_hooks %}

**Step**: {{ h.name }}
**Success**: {% if h.success %}:thumbsup:{% else %}:heavy_multiplication_x:{% endif %}
      {% if h.cmd is defined %}
**Command** : `{{ h.cmd }}`
      {%- endif %}
      {%- if h.details is defined %}
**Details**: {{ h.details }}
      {%- endif %}
      {% if not compact_view %}
```
{{ h.text }}
```
    {%- else %}

No output shown due to comment size.

    {%- endif %}
    {%- endfor %}
</details>

{%- endif %}
{%- for d in dirspaces %}

## Dir: {{ d.dir }} | {% if d.success %}{% if d.has_changes is defined and d.has_changes %}Success :thumbsup:{% elif d.has_changes is defined and not d.has_changes %}No changes{% endif %}{% else %}:heavy_multiplication_x:{% endif %}
  {%- if compact_dirspaces %}
<details>
  <summary>Expand for details</summary>

---

  {% endif %}
**Dir**: {{ d.dir }}
**Workspace**: {{ d.workspace }}
**Success**: {% if d.success %}:thumbsup:{% else %}:heavy_multiplication_x:{% endif %}

  {%- for s in d.steps %}

**Step**: {{ s.name }}
**Success**: {% if s.success %}:thumbsup:{% else %}:heavy_multiplication_x:{% endif %}
    {%- if s.cmd is defined %}
**Command**: `{{ s.cmd }}`
    {%- endif %}
    {%- if s.details is defined %}
**Details**: {{ s.details }}
    {%- endif %}
    {%- if not compact_view %}

```{{ s.text_decorator }}
{{ s.text }}
```

    {%- else %}

No output shown due to comment size.

    {%- endif %}
  {%- endfor %}
  {%- if compact_dirspaces %}
</details>

  {%- endif %}
{%- endfor %}

</details>

  {%- if cost_estimation is defined %}

## Cost Estimation

    {%- if cost_estimation.success %}
**Total Monthly Difference: {{ cost_estimation.diff_monthly_cost | round(2)}} {{ cost_estimation.currency }}**
<details>
  <summary>Expand for cost estimation details</summary>

| Dir | Workspace | Previous ({{ cost_estimation.currency }}) | New ({{ cost_estimation.currency }}) | Diff ({{ cost_estimation.currency }}) |
| :---: | :---: | ---: | ---: | ---: |
  {%- for d in cost_estimation.dirspaces %}
| {{ d.dir }} | {{ d.workspace }} | {{ d.prev_monthly_cost | round(2) }} | {{ d.total_monthly_cost | round(2) }} | {{ d.diff_monthly_cost | round(2) }} |
  {%- endfor %}
| | **Total** | **{{ cost_estimation.prev_monthly_cost | round(2) }}** | **{{ cost_estimation.total_monthly_cost | round(2) }}** | **{{ cost_estimation.diff_monthly_cost | round(2) }}** |

    {%- else %}

**Error calculating Cost Estimation**
<details>
  <summary>Expand for cost estimation details</summary>

{%- if cost_estimation.text is defined %}

```
{{ cost_estimation.text }}
```

{%- endif %}
{%- endif %}

</details>
{%- endif %}
{%- if overall_success %}

---

To apply all these changes, comment:

```
terrateam apply
```

{%- endif %}

---

<details>
  <summary><h3>Feedback?</h3></summary>

Questions? Comments? Give feedback by commenting `terrateam feedback <your msg>`.  Your message lands directly in our inbox.

</details>
